{% load i18n %}
<div class="flex flex-col {{ widget.attrs.class }}">
    <div class="p-4 text-black">
        <p class="text-xs font-normal mb-2">
            {% translate 'The groups have been split up into different main groups to make it easier to find your group. Choose the main group that your group belongs to and then your group.' %}
        </p>
        <select id="main-group" class="mb-2 border border-solid border-gray-200 p-2 w-full">
            <option value="" disabled selected>{% translate 'Choose a main group' %}</option>
            {% for key, group in groups.items %}
            <option value="{{ key }}">{{ group.verbose_name }}</option>
            {% endfor %}
        </select>

        <select
            name="{{ widget.name }}"
            id="{{ widget.attrs.id }}"
            {% if widget.attrs.required %}required{% endif %}
            class="border border-solid border-gray-200 p-2 w-full"
        >
            <option value="" disabled selected>{% translate 'Choose your group' %}</option>
        </select>
    </div>
</div>

<script>
    //Isolate the code using the javascript module pattern
    (function() {
        {% autoescape off %}
        var lookup = {
            {% for key, verbose_names in groups_verbose_names.items %}
            '{{ key }}': {{ verbose_names }},
            {% endfor %}
        };
        {% endautoescape %}

        // When the main group is changed, only display the groups in that main group
        document.getElementById('main-group').addEventListener('change', function() {
            const selectedValue = this.value;

            const group = document.getElementById('{{ widget.attrs.id }}');

            // Empty the current groups in the select tag
            group.innerHTML = "";

            // For each group in the selected main group,
            // only add the groups that belong to that main group
            for (i = 0; i < lookup[selectedValue].length; i++) {
                var parser = new DOMParser();
                var doc = parser.parseFromString("<option value='" + lookup[selectedValue][i] + "'>" + lookup[selectedValue][i] + "</option>", 'text/html');
                // DOMParser adds a body tag around the option tag. To get rid of it we
                // append the first child in the body tag a.k.a. the option tag
                group.append(doc.body.firstChild);
            }
        });
    })();
</script>
